<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Search & Edit</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; background-color: #f8f9fa; }
        h2 { text-align: center; margin-bottom: 20px; }
        
        /* Filters */
        #filters {
            background: white; padding: 15px; border-radius: 5px;
            margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #filters input {
            padding: 6px; border: 1px solid #ccc; border-radius: 4px;
        }
        #filters button {
            background: #007bff; color: white; border: none;
            padding: 7px 14px; cursor: pointer; border-radius: 4px;
        }
        #filters button:hover { background: #0056b3; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; }
        table th, table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        table th { background-color: #007bff; color: white; }
        .edit-btn {
            background-color: #28a745; color: white; padding: 6px 10px;
            cursor: pointer; border: none; border-radius: 4px;
        }
        .edit-btn:hover { background-color: #218838; }

        /* Pagination */
        #pagination { text-align: center; margin-top: 15px; }
        #pagination button {
            margin: 2px; padding: 6px 10px; border: 1px solid #ccc;
            cursor: pointer; border-radius: 4px; background: white;
        }
        #pagination button.active { background: #007bff; color: white; }

        /* Edit Modal */
        .modal {
            display: none; position: fixed; z-index: 999;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); overflow: auto; padding-top: 60px;
        }
        .modal-content {
            background: white; margin: auto; padding: 20px;
            width: 500px; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;
        }
        .modal-header h3 { margin: 0; }
        .close { font-size: 22px; cursor: pointer; color: #888; }
        .close:hover { color: black; }

        /* Form */
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 60px; }
        .save-btn {
            background-color: #007bff; color: white; padding: 10px 16px;
            border: none; border-radius: 4px; cursor: pointer;
            width: 100%; font-size: 16px;
        }
        .save-btn:hover { background-color: #0056b3; }

        /* Message */
        #messageBox {
            display: none; padding: 10px; margin-bottom: 15px;
            border-radius: 4px; color: white;
        }
    </style>
</head>
<body>

<h2>Course Search & Edit</h2>

<!-- Search Filters -->
<div id="filters">
    <input type="text" id="filterCategory" placeholder="Category">
    <input type="text" id="filterType" placeholder="Type">
    <input type="number" id="filterMinAge" placeholder="Min Age">
    <input type="number" id="filterMaxAge" placeholder="Max Age">
    <input type="number" id="filterMinPrice" placeholder="Min Price">
    <input type="number" id="filterMaxPrice" placeholder="Max Price">
    <button onclick="searchCourses(0)">Search</button>
    <button onclick="loadCourses(0)">Reset</button>
</div>

<div id="messageBox"></div>

<table id="courseTable">
    <thead>
        <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Type</th>
            <th>Price</th>
            <th>Next Session</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Pagination -->
<div id="pagination"></div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Course</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>

        <input type="hidden" id="courseId">

        <div class="form-group"><label>Title</label><input type="text" id="courseTitle"></div>
        <div class="form-group"><label>Description</label><textarea id="courseDescription"></textarea></div>
        <div class="form-group"><label>Category</label><input type="text" id="courseCategory"></div>
        <div class="form-group"><label>Type</label><input type="text" id="courseType"></div>
        <div class="form-group"><label>Grade Range</label><input type="text" id="courseGradeRange"></div>
        <div class="form-group"><label>Min Age</label><input type="number" id="courseMinAge"></div>
        <div class="form-group"><label>Max Age</label><input type="number" id="courseMaxAge"></div>
        <div class="form-group"><label>Price</label><input type="number" id="coursePrice" step="0.01"></div>
        <div class="form-group"><label>Next Session Date</label><input type="datetime-local" id="courseDate"></div>

        <button class="save-btn" onclick="saveCourse()">Save Changes</button>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api/search";
    let currentPage = 0, totalPages = 0, lastSearchUrl = "";

    function showMessage(msg, color) {
        const box = document.getElementById("messageBox");
        box.textContent = msg;
        box.style.backgroundColor = color;
        box.style.display = "block";
        setTimeout(() => box.style.display = "none", 3000);
    }

    function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        if (totalPages <= 1) return;

        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            if (i === currentPage) btn.classList.add("active");
            btn.onclick = () => {
                if (lastSearchUrl.includes("/all")) loadCourses(i);
                else searchCourses(i);
            };
            pagination.appendChild(btn);
        }
    }

    function loadCourses(page = 0) {
        currentPage = page;
        lastSearchUrl = `${API_BASE}/all?page=${page}&size=10`;
        fetch(lastSearchUrl)
            .then(res => res.json())
            .then(data => {
                renderTable(data.content);
                totalPages = data.totalPages;
                renderPagination();
            });
    }

    function searchCourses(page = 0) {
        currentPage = page;
        const category = document.getElementById("filterCategory").value;
        const type = document.getElementById("filterType").value;
        const minAge = document.getElementById("filterMinAge").value;
        const maxAge = document.getElementById("filterMaxAge").value;
        const minPrice = document.getElementById("filterMinPrice").value;
        const maxPrice = document.getElementById("filterMaxPrice").value;

        let url = `${API_BASE}?page=${page}&size=10`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (type) url += `&type=${encodeURIComponent(type)}`;
        if (minAge) url += `&minAge=${minAge}`;
        if (maxAge) url += `&maxAge=${maxAge}`;
        if (minPrice) url += `&minPrice=${minPrice}`;
        if (maxPrice) url += `&maxPrice=${maxPrice}`;

        lastSearchUrl = url;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderTable(data.content);
                totalPages = data.totalPages;
                renderPagination();
            });
    }

    function renderTable(courses) {
        const tbody = document.querySelector("#courseTable tbody");
        tbody.innerHTML = "";
        courses.forEach(course => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${course.title || ''}</td>
                <td>${course.category || ''}</td>
                <td>${course.type || ''}</td>
                <td>${course.price ?? ''}</td>
                <td>${course.nextSessionDate ? new Date(course.nextSessionDate).toLocaleString() : ''}</td>
                <td><button class="edit-btn" onclick='editCourse(${JSON.stringify(course)})'>Edit</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function editCourse(course) {
        document.getElementById("courseId").value = course.id || '';
        document.getElementById("courseTitle").value = course.title || '';
        document.getElementById("courseDescription").value = course.description || '';
        document.getElementById("courseCategory").value = course.category || '';
        document.getElementById("courseType").value = course.type || '';
        document.getElementById("courseGradeRange").value = course.gradeRange || '';
        document.getElementById("courseMinAge").value = course.minAge ?? '';
        document.getElementById("courseMaxAge").value = course.maxAge ?? '';
        document.getElementById("coursePrice").value = course.price ?? '';
        document.getElementById("courseDate").value = course.nextSessionDate
            ? new Date(course.nextSessionDate).toISOString().slice(0, 16)
            : '';

        document.getElementById("editModal").style.display = "block";
    }

    function saveCourse() {
        const updatedCourse = {
            id: document.getElementById("courseId").value,
            title: document.getElementById("courseTitle").value,
            description: document.getElementById("courseDescription").value,
            category: document.getElementById("courseCategory").value,
            type: document.getElementById("courseType").value,
            gradeRange: document.getElementById("courseGradeRange").value,
            minAge: parseInt(document.getElementById("courseMinAge").value) || null,
            maxAge: parseInt(document.getElementById("courseMaxAge").value) || null,
            price: parseFloat(document.getElementById("coursePrice").value) || null,
            nextSessionDate: document.getElementById("courseDate").value
                ? new Date(document.getElementById("courseDate").value).toISOString()
                : null
        };

        fetch(`${API_BASE}/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedCourse)
        })
        .then(res => {
            if (!res.ok) throw new Error();
            return res.json();
        })
        .then(() => {
            showMessage("✅ Course updated successfully!", "green");
            closeModal();
            if (lastSearchUrl.includes("/all")) loadCourses(currentPage);
            else searchCourses(currentPage);
        })
        .catch(() => {
            showMessage("❌ Failed to update course", "red");
        });
    }

    function closeModal() {
        document.getElementById("editModal").style.display = "none";
    }

    window.onload = () => loadCourses(0);
</script>

</body>
</html>
